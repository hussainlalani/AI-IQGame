<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered IQ Test Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease-in-out;
        }
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .option-btn {
            border: 2px solid #e5e7eb;
            text-align: left;
        }
        .option-btn:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .option-btn.selected {
            border-color: #3b82f6;
            background-color: #dbeafe;
        }
        .progress-bar-inner {
            transition: width 0.5s ease-in-out;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div id="game-container" class="w-full max-w-2xl mx-auto">
        <!-- Start Screen -->
        <div id="start-screen" class="card p-8 md:p-12 text-center">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-2">AI-Powered IQ Challenge</h1>
            <p class="text-gray-500 text-md mb-6">A Challenge by Hussain Lalani</p>
            <p class="text-gray-600 text-lg mb-8">Test your logic with unique questions generated by AI. Click the button below to begin.</p>
            <button id="start-btn" class="btn bg-blue-500 text-white font-bold py-3 px-8 rounded-full text-xl shadow-lg">✨ Start AI Test</button>
            <div id="start-loader" class="mt-6 hidden">
                <div class="loader mx-auto"></div>
                <p class="text-gray-500 mt-2">Generating new questions...</p>
            </div>
            <div id="error-message" class="text-red-500 mt-4 hidden font-medium"></div>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="card p-8 md:p-12 hidden">
            <div class="mb-6">
                <div class="flex justify-between items-center mb-2">
                    <p class="text-sm font-medium text-gray-500">Question <span id="question-number"></span> of 20</p>
                    <p class="text-sm font-medium text-blue-600">Score: <span id="current-score">80</span></p>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-blue-500 h-2.5 rounded-full progress-bar-inner" style="width: 0%"></div>
                </div>
            </div>
            <h2 id="question-text" class="text-2xl font-semibold text-gray-800 mb-8 min-h-[6rem]"></h2>
            <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            <div class="mt-10 text-right">
                <button id="next-btn" class="btn bg-gray-300 text-gray-600 font-bold py-2 px-6 rounded-lg" disabled>Next</button>
            </div>
        </div>

        <!-- Result Screen -->
        <div id="result-screen" class="card p-8 md:p-12 text-center hidden">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Test Completed!</h1>
            <p class="text-gray-600 text-lg mb-6">Here is your estimated IQ score.</p>
            <div class="bg-blue-500 text-white rounded-full w-48 h-48 flex items-center justify-center mx-auto mb-6 shadow-2xl">
                <div>
                    <p class="text-5xl font-bold" id="final-score"></p>
                    <p class="text-lg">IQ Score</p>
                </div>
            </div>
            <p id="result-message" class="text-gray-700 text-xl mb-8"></p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button id="restart-btn" class="btn bg-gray-600 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg">Try Again</button>
                <button id="analysis-btn" class="btn bg-purple-600 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg">✨ Get Detailed Analysis</button>
            </div>
            <div id="analysis-loader" class="mt-6 hidden">
                <div class="loader mx-auto"></div>
                <p class="text-gray-500 mt-2">Generating your analysis...</p>
            </div>
            <div id="analysis-result" class="mt-8 text-left bg-gray-50 p-6 rounded-lg hidden"></div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const startScreen = document.getElementById('start-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultScreen = document.getElementById('result-screen');
        const startBtn = document.getElementById('start-btn');
        const nextBtn = document.getElementById('next-btn');
        const restartBtn = document.getElementById('restart-btn');
        const analysisBtn = document.getElementById('analysis-btn');
        const questionNumberEl = document.getElementById('question-number');
        const questionTextEl = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const progressBar = document.getElementById('progress-bar');
        const currentScoreEl = document.getElementById('current-score');
        const finalScoreEl = document.getElementById('final-score');
        const resultMessageEl = document.getElementById('result-message');
        const startLoader = document.getElementById('start-loader');
        const analysisLoader = document.getElementById('analysis-loader');
        const analysisResultEl = document.getElementById('analysis-result');
        const errorMessageEl = document.getElementById('error-message');

        // --- State Variables ---
        let currentQuestionIndex = 0;
        let score = 80; // Starting IQ score
        let selectedOption = null;
        let questions = []; // Will be filled by the API

        // --- Gemini API Configuration ---
        const apiKey = ""; // This will be handled by the execution environment.

        /**
         * Generates new IQ questions using the Gemini API.
         */
        async function generateQuestions() {
            startBtn.disabled = true;
            startLoader.classList.remove('hidden');
            errorMessageEl.classList.add('hidden'); // Hide previous errors

            const prompt = "Generate 20 unique IQ test questions covering logic, spatial reasoning, verbal ability, and pattern recognition. Ensure the questions are distinct and challenging. For each question, provide four options and specify the correct answer.";
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            questions: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        question: { type: "STRING" },
                                        options: { type: "ARRAY", items: { type: "STRING" } },
                                        answer: { type: "STRING" }
                                    },
                                    required: ["question", "options", "answer"]
                                }
                            }
                        },
                        required: ["questions"]
                    }
                }
            };

            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}. This can happen if the API key is missing or invalid.`);
                }

                const result = await response.json();
                
                if (!result.candidates || !result.candidates[0].content.parts[0].text) {
                    throw new Error("Received an invalid response structure from the API.");
                }

                const jsonText = result.candidates[0].content.parts[0].text;
                const parsedData = JSON.parse(jsonText);
                
                if (parsedData.questions && parsedData.questions.length > 0) {
                    questions = parsedData.questions;
                    startQuiz();
                } else {
                    throw new Error("API response did not contain valid question data.");
                }

            } catch (error) {
                console.error("Error generating questions:", error);
                // Display a user-friendly error message on the screen
                errorMessageEl.textContent = "Failed to generate new questions. Please check your connection and try again.";
                errorMessageEl.classList.remove('hidden');
                startBtn.disabled = false; // Allow the user to try again
            } finally {
                startLoader.classList.add('hidden');
            }
        }

        /**
         * Starts the quiz after questions are generated.
         */
        function startQuiz() {
            startScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            resultScreen.classList.add('hidden');
            analysisResultEl.classList.add('hidden');
            analysisBtn.disabled = false;

            currentQuestionIndex = 0;
            score = 80;
            currentScoreEl.textContent = score;
            showQuestion();
        }

        /**
         * Displays the current question and its options.
         */
        function showQuestion() {
            resetState();
            const currentQuestion = questions[currentQuestionIndex];
            questionNumberEl.textContent = currentQuestionIndex + 1;
            questionTextEl.textContent = currentQuestion.question;
            
            const shuffledOptions = [...currentQuestion.options].sort(() => Math.random() - 0.5);

            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.innerHTML = option;
                button.classList.add('btn', 'option-btn', 'w-full', 'p-4', 'rounded-lg', 'text-lg');
                button.addEventListener('click', () => selectOption(button, option));
                optionsContainer.appendChild(button);
            });

            updateProgressBar();
        }

        /**
         * Resets the state for the next question.
         */
        function resetState() {
            nextBtn.disabled = true;
            nextBtn.classList.add('bg-gray-300', 'text-gray-600');
            nextBtn.classList.remove('bg-blue-500', 'text-white');
            while (optionsContainer.firstChild) {
                optionsContainer.removeChild(optionsContainer.firstChild);
            }
            selectedOption = null;
        }

        /**
         * Handles the user's selection of an answer option.
         */
        function selectOption(buttonEl, option) {
            const previouslySelected = optionsContainer.querySelector('.selected');
            if (previouslySelected) {
                previouslySelected.classList.remove('selected');
            }
            buttonEl.classList.add('selected');
            selectedOption = option;
            nextBtn.disabled = false;
            nextBtn.classList.remove('bg-gray-300', 'text-gray-600');
            nextBtn.classList.add('bg-blue-500', 'text-white');
        }

        /**
         * Updates the progress bar.
         */
        function updateProgressBar() {
            const progressPercentage = ((currentQuestionIndex) / questions.length) * 100;
            progressBar.style.width = `${progressPercentage}%`;
        }
        
        /**
         * Handles moving to the next question or showing results.
         */
        function handleNextButton() {
            if (selectedOption === questions[currentQuestionIndex].answer) {
                score += 3.5;
            }
            currentScoreEl.textContent = Math.round(score);
            currentQuestionIndex++;
            if (currentQuestionIndex < questions.length) {
                showQuestion();
            } else {
                showResults();
            }
        }

        /**
         * Displays the final results screen.
         */
        function showResults() {
            quizScreen.classList.add('hidden');
            resultScreen.classList.remove('hidden');
            const finalScore = Math.round(score);
            finalScoreEl.textContent = finalScore;

            let message = "";
            if (finalScore >= 140) message = "Exceptional! A truly gifted mind.";
            else if (finalScore >= 120) message = "Excellent! You have superior intelligence.";
            else if (finalScore >= 110) message = "Great job! You have high average intelligence.";
            else if (finalScore >= 90) message = "Good work! You have average intelligence.";
            else message = "You've completed the challenge!";
            resultMessageEl.textContent = message;
        }

        /**
         * Fetches and displays a detailed analysis of the user's score.
         */
        async function getDetailedAnalysis() {
            analysisBtn.disabled = true;
            analysisLoader.classList.remove('hidden');
            analysisResultEl.classList.add('hidden');

            const finalScore = Math.round(score);
            const prompt = `A user just completed an IQ test and scored ${finalScore}. Provide an encouraging and detailed analysis of this score. Explain what this IQ range typically means in terms of cognitive abilities (e.g., problem-solving, learning speed, abstract thinking). Keep the tone positive and motivational. Format the output as a single block of text.`;

            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const result = await response.json();
                const analysisText = result.candidates[0].content.parts[0].text;
                analysisResultEl.innerHTML = analysisText.replace(/\n/g, '<br>');
                analysisResultEl.classList.remove('hidden');

            } catch (error) {
                console.error("Error getting analysis:", error);
                analysisResultEl.textContent = "Sorry, we couldn't generate your analysis at this time.";
                analysisResultEl.classList.remove('hidden');
            } finally {
                analysisLoader.classList.add('hidden');
            }
        }

        // --- Event Listeners ---
        startBtn.addEventListener('click', generateQuestions);
        nextBtn.addEventListener('click', handleNextButton);
        analysisBtn.addEventListener('click', getDetailedAnalysis);
        restartBtn.addEventListener('click', () => {
             resultScreen.classList.add('hidden');
             startScreen.classList.remove('hidden');
             startBtn.disabled = false;
             progressBar.style.width = '0%';
             errorMessageEl.classList.add('hidden');
        });
    </script>
</body>
</html>
